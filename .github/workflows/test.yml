on: [push, pull_request]

name: Tests

jobs:
  unit_test_mac:
    env:
      GO111MODULE: auto
    strategy:
      matrix:
        go-version: [1.11, 1.x] # Test min/max supported versions of Go
    runs-on: macos-latest
    steps:
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go-version }}
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Print env
        run: env
      - name: Test
        run: |
          make
          ./bin/docker-credential-gcr configure-docker
          make test

  unit_test_windows:
    env:
      GO111MODULE: auto
    strategy:
      matrix:
        go-version: [1.11, 1.x] # Test min/max supported versions of Go
    runs-on: windows-latest
    steps:
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go-version }}
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Print env
        run: env
      - name: Test
        run: |
          go test -race -timeout 10s -v -tags=unit ./...
          go build -o docker-credential-gcr.exe main.go
          ./docker-credential-gcr.exe configure-docker

  e2e_test_ubuntu:
    env:
      GO111MODULE: auto
      FULL_TEST: yes
    runs-on: ubuntu-latest
    steps:
      - name: Install Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ matrix.go-version }}
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Print env
        run: env
      - name: Verify go cmds # Verify go lint, go vet, gofmt, go fix, etc.
        run: |
          gofmt -e -l .
          make criticism
          make presubmit
      - name: Verify vanilla build
        run: |
          make
          ./bin/docker-credential-gcr configure-docker
      - name: Verify correctness
        run: go build -a -v -race main.go
      - name: Destructive tests
        run: |
          make test-bin
          go test -timeout 10s -v -tags=e2e
      - name: Bazel tests
        run: |
          bazelisk clean
          bazelisk build //...
          bazelisk test //...
